<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Where-Ya-At Bulb</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 16px; color: #f5f5f5; }
      .row { display: flex; gap: 16px; flex-wrap: wrap; }
      .card { border: 1px solid #3a3a3a; border-radius: 10px; padding: 16px; max-width: 860px; background: rgba(20, 20, 20, 0.85); }
      label { display:block; font-weight: 650; margin-top: 10px; color: #f5f5f5; }
      input[type=text], input[type=number], select { width: 520px; max-width: 100%; padding: 10px; background: #0f0f0f; color: #ffffff; border: 1px solid #555; border-radius: 8px; }
      input[type=color] { width: 100%; max-width: 100%; height: 44px; padding: 4px; background: #0f0f0f; border: 1px solid #555; border-radius: 8px; }
      input[type=range] { width: 100%; max-width: 100%; }
      input::placeholder { color: #8f8f8f; }
      button { padding: 10px 14px; font-weight: 800; background: #2f6fed; color: #fff; border: 0; border-radius: 10px; cursor: pointer; }
      button:hover { background: #245bd0; }
      .modegrid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .mode { border: 1px solid #3a3a3a; border-radius: 10px; padding: 12px; background: rgba(0, 0, 0, 0.25); }
      .hint { color: #b8b8b8; font-size: 13px; margin-top: 6px; }
      .stack { display: grid; gap: 8px; }
      .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: center; }
      textarea { width: 520px; max-width: 100%; padding: 10px; background: #0f0f0f; color: #ffffff; border: 1px solid #555; border-radius: 8px; }
    </style>
  </head>
  <body>
    <h1>Where-Ya-At Bulb</h1>

    <div class="card">
      <form method="post" action="save">
        <h2>Core Entities</h2>

        <label>Phone tracker entity</label>
        <input type="text" name="phone_tracker" value="{{ cfg.get('phone_tracker','') }}" placeholder="device_tracker.your_iphone" />
        <div class="hint">From the Home Assistant Companion App.</div>

        <label>Light entity</label>
        <input type="text" name="light_entity" value="{{ cfg.get('light_entity','') }}" placeholder="light.your_govee_bulb" />

        <label>Location mode helper</label>
        <input type="text" name="location_mode_entity" value="{{ cfg.get('location_mode_entity','input_select.location_mode') }}" />

        <label>Manual override helper</label>
        <input type="text" name="manual_override_entity" value="{{ cfg.get('manual_override_entity','input_boolean.light_manual_override') }}" />

        <label>Dwell seconds (anti-flicker)</label>
        <input type="number" min="30" max="3600" name="dwell_seconds" value="{{ cfg.get('dwell_seconds',300) }}" />

        <h2>Zones</h2>

        <label>Florida zones (comma-separated)</label>
        <input type="text" name="zones_florida" value="{{ (cfg.get('zones_florida') or []) | join(',') }}" placeholder="florida,florida_house" />

        <label>Work zone</label>
        <input type="text" name="zone_work" value="{{ cfg.get('zone_work','') }}" placeholder="work" />

        <label>Airport zone (optional)</label>
        <input type="text" name="zone_airport" value="{{ cfg.get('zone_airport','') }}" placeholder="airport" />

        <label>Shopping zone prefix</label>
        <input type="text" name="shopping_prefix" value="{{ cfg.get('shopping_prefix','shopping_') }}" />
        <div class="hint">Any zone state starting with this prefix will map to SHOPPING.</div>

        <h2>Govee Effects (optional)</h2>
        <div class="hint">Paste the light's effect_list here once (comma-separated). Then choose effects per mode using the dropdown/autocomplete below.</div>
        <label>Available effects (comma-separated)</label>
        <textarea name="effects_csv" rows="4" placeholder="Adventure Game, Aurora, Rainbow, ...">{{ (cfg.get('effects') or []) | join(', ') }}</textarea>

        <datalist id="effectsList">
          {% for eff in (cfg.get('effects') or []) %}
            <option value="{{ eff }}"></option>
          {% endfor %}
        </datalist>

        <h2>Mode Lighting</h2>
        <div class="hint">Pick a color (or use a preset). Brightness is optional; leave it blank to avoid changing brightness. If your light supports effects, you can also set an effect by name.</div>

        <div class="modegrid">
          {% for mode in ['HOME','WORK','FLORIDA','SHOPPING','TRAVELING','UNKNOWN'] %}
          <div class="mode">
            <div><strong>{{ mode }}</strong></div>
            <div class="stack">
              <label>Effect (optional)</label>
              <input type="text" list="effectsList" name="{{ mode|lower }}_effect" value="{{ (cfg.get('colors',{}).get(mode,{}) or {}).get('effect','') }}" placeholder="e.g. Rainbow" />

              <label>Color</label>
              <div class="row2">
                <select data-mode="{{ mode|lower }}" class="preset">
                  <option value="">Preset (optional)</option>
                  <option value="#ffffff">White</option>
                  <option value="#ffd6a0">Warm White</option>
                  <option value="#cfe8ff">Cool White</option>
                  <option value="#ff0000">Red</option>
                  <option value="#00ff00">Green</option>
                  <option value="#0000ff">Blue</option>
                  <option value="#ff00ff">Purple</option>
                  <option value="#ffa500">Orange</option>
                </select>
                <input type="color" name="{{ mode|lower }}_color" value="{{ (cfg.get('colors',{}).get(mode,{}) or {}).get('hex','#ffffff') }}" />
              </div>

              <label>Brightness (optional)</label>
              <input type="range" min="1" max="255" value="{{ (cfg.get('colors',{}).get(mode,{}) or {}).get('brightness','255') or '255' }}" data-mode="{{ mode|lower }}" class="bri" />
              <input type="number" min="1" max="255" name="{{ mode|lower }}_brightness" value="{{ (cfg.get('colors',{}).get(mode,{}) or {}).get('brightness','') }}" placeholder="(leave blank)" data-mode="{{ mode|lower }}" class="briNum" />
            </div>
          </div>
          {% endfor %}
        </div>

        <h2>Optional Flourish</h2>
        <label>
          <input type="checkbox" name="flourish_enabled" {% if cfg.get('flourish_enabled') %}checked{% endif %} />
          Enable a short flourish the first time HOME triggers each day
        </label>

        <div style="margin-top: 16px" class="row">
          <button type="submit">Save</button>
        </div>
      </form>

      <form method="post" action="apply" style="margin-top: 12px">
        <button type="submit">Apply (Generate YAML)</button>
      </form>

      <div class="hint" style="margin-top: 10px;">
        Output file: /config/{{ cfg.get('package_path','packages/where_ya_at_bulb_generated.yaml') }}
      </div>
    </div>

    <script>
      (function() {
        function syncBrightness(mode) {
          const range = document.querySelector('input.bri[data-mode="' + mode + '"]');
          const num = document.querySelector('input.briNum[data-mode="' + mode + '"]');
          if (!range || !num) return;

          if (num.value === '') {
            range.disabled = true;
            range.value = 255;
          } else {
            range.disabled = false;
            range.value = num.value;
          }

          range.addEventListener('input', function() {
            num.value = range.value;
          });

          num.addEventListener('input', function() {
            if (num.value === '') {
              range.disabled = true;
              range.value = 255;
              return;
            }
            range.disabled = false;
            range.value = num.value;
          });
        }

        function setupPreset(mode) {
          const preset = document.querySelector('select.preset[data-mode="' + mode + '"]');
          const color = document.querySelector('input[type=color][name="' + mode + '_color"]');
          if (!preset || !color) return;
          preset.addEventListener('change', function() {
            if (preset.value) {
              color.value = preset.value;
            }
          });
        }

        ['home','work','florida','shopping','traveling','unknown'].forEach(function(mode) {
          syncBrightness(mode);
          setupPreset(mode);
        });
      })();
    </script>
  </body>
</html>
